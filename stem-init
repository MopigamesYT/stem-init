#!/bin/bash

set -e

# Parse arguments
FORCE=false
POSITIONAL=()
for arg in "$@"; do
  case "$arg" in
    -h|--help)
      echo "󰐗 stem-init — project scaffolding tool"
      echo
      echo "Usage: stem-init [options] [project_name]"
      echo
      echo "Options:"
      echo "  -h, --help    Show this help message"
      echo "  -f, --force   Override non-empty directory check"
      echo
      echo "If no project_name is given, the current directory name is used."
      exit 0
      ;;
    -f|--force)
      FORCE=true
      ;;
    *)
      POSITIONAL+=("$arg")
      ;;
  esac
done

# Fail if directory is not empty (excluding .git)
if [ "$FORCE" = false ] && find . -mindepth 1 -maxdepth 1 ! -name '.git' | read -r _; then
  echo "󰅙 Error: directory is not empty (excluding .git)"
  echo "       Please run this in an empty project folder."
  echo "       Use --force to override."
  exit 1
fi

# Project name
if [ -n "${POSITIONAL[0]}" ]; then
  PROJECT_NAME="${POSITIONAL[0]}"
else
  PROJECT_NAME="$(basename "$(pwd)")"
fi

# Ask for binary name (default: text between 6th and 7th dash, without trailing digits)
# Count dashes to ensure we have enough fields
DASH_COUNT=$(echo "$PROJECT_NAME" | tr -cd '-' | wc -c)
if [ "$DASH_COUNT" -ge 6 ]; then
  DEFAULT_BINARY=$(echo "$PROJECT_NAME" | cut -d'-' -f7 | sed 's/[0-9]*$//')
else
  DEFAULT_BINARY="$PROJECT_NAME"
fi
# Fallback to project name if extraction resulted in empty string
if [ -z "$DEFAULT_BINARY" ]; then
  DEFAULT_BINARY="$PROJECT_NAME"
fi
printf "Binary name (default: %s): " "$DEFAULT_BINARY"
read -r BINARY_NAME
if [ -z "$BINARY_NAME" ]; then
  BINARY_NAME="$DEFAULT_BINARY"
fi

ESCAPED_NAME=$(printf '%s\n' "$PROJECT_NAME" | sed 's/[\/&]/\\&/g')
ESCAPED_BINARY=$(printf '%s\n' "$BINARY_NAME" | sed 's/[\/&]/\\&/g')

echo "󰐗 Initializing project: $PROJECT_NAME (binary: $BINARY_NAME)"

# Copy template quietly
rsync -a --exclude='/.git' --quiet "$XDG_CONFIG_HOME/stem-init/" ./

# Replace placeholders
CURRENT_YEAR=$(date +%Y)

grep -rl --binary-files=without-match "CURRENT_YEAR" . \
  | xargs sed -i "s/CURRENT_YEAR/${CURRENT_YEAR}/g"

grep -rl --binary-files=without-match "PROJECT_NAME" . \
  | xargs sed -i "s/PROJECT_NAME/${ESCAPED_NAME}/g"

grep -rl --binary-files=without-match "BINARY_NAME" . \
  | xargs sed -i "s/BINARY_NAME/${ESCAPED_BINARY}/g"

echo "󰄬 Template applied successfully"

echo
echo "--------------------------------"

make help || true

echo
tree -a -I .git
